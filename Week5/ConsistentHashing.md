ä¸€è‡´æ€§å“ˆå¸Œï¼ˆConsistent Hashingï¼‰ æ˜¯ä¸€ç§ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•°æ®åˆ†å¸ƒç­–ç•¥ï¼Œç‰¹åˆ«é€‚ç”¨äº åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚ Memcachedï¼‰ã€åˆ†å¸ƒå¼æ•°æ®åº“ï¼ˆå¦‚ Cassandraï¼‰ã€è´Ÿè½½å‡è¡¡ ç­‰åº”ç”¨åœºæ™¯

# ğŸŒŸ ä¸€è‡´æ€§å“ˆå¸Œçš„æ ¸å¿ƒæ¦‚å¿µ

1. å°†æ•´ä¸ªå“ˆå¸Œç©ºé—´æ˜ å°„ä¸ºä¸€ä¸ªâ€œå“ˆå¸Œç¯â€ï¼ˆHash Ringï¼‰ï¼š

- å“ˆå¸Œå‡½æ•°ï¼ˆå¦‚ MD5ã€SHA-1ï¼‰çš„å€¼èŒƒå›´é€šå¸¸æ˜¯ 0 ~ 2^m - 1ï¼ˆm ä¸ºå“ˆå¸Œä½æ•°ï¼‰ã€‚
- è¿™äº›å€¼æ„æˆä¸€ä¸ªé€»è¾‘ä¸Šçš„ç¯å½¢ç»“æ„ã€‚

2. æœåŠ¡å™¨ï¼ˆèŠ‚ç‚¹ï¼‰åœ¨ç¯ä¸Šéšæœºæ˜ å°„ä¸€ä¸ªå“ˆå¸Œå€¼ï¼š

- ä½¿ç”¨ hash(æœåŠ¡å™¨ IP) ç¡®å®šæ¯ä¸ªæœåŠ¡å™¨åœ¨ç¯ä¸Šçš„ä½ç½®ã€‚

3. æ•°æ®æ ¹æ®é”®ï¼ˆKeyï¼‰è¿›è¡Œå“ˆå¸Œï¼Œå¹¶å­˜å‚¨åˆ°é¡ºæ—¶é’ˆæ–¹å‘çš„æœ€è¿‘èŠ‚ç‚¹ï¼š

- è®¡ç®— hash(æ•°æ® Key)ï¼Œä»å“ˆå¸Œç¯ä¸Šæ‰¾åˆ°é¡ºæ—¶é’ˆæœ€è¿‘çš„æœåŠ¡å™¨å­˜å‚¨æ•°æ®ã€‚

4. èŠ‚ç‚¹çš„å¢åˆ å¯¹ç³»ç»Ÿçš„å½±å“è¾ƒå°ï¼š

- æ–°å¢èŠ‚ç‚¹ï¼šåªå½±å“å“ˆå¸Œç¯ä¸Šéƒ¨åˆ†æ•°æ®çš„å­˜å‚¨ä½ç½®ï¼Œå‡å°‘äº†æ•°æ®è¿ç§»é‡ã€‚
- åˆ é™¤èŠ‚ç‚¹ï¼šä»…éœ€å°†è¯¥èŠ‚ç‚¹çš„æ•°æ®é‡æ–°æ˜ å°„åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ•°æ®é‡æ–°åˆ†å¸ƒã€‚

# ğŸ¯ ä¸€è‡´æ€§å“ˆå¸Œ vs ä¼ ç»Ÿå“ˆå¸Œ

ä¼ ç»Ÿå“ˆå¸Œï¼ˆå¦‚å–æ¨¡ hash(key) % Nï¼‰çš„ç¼ºç‚¹ï¼š
âœ… å½“æœåŠ¡å™¨æ•°é‡å˜åŒ–æ—¶ï¼Œå‡ ä¹æ‰€æœ‰æ•°æ®éƒ½è¦é‡æ–°åˆ†å¸ƒï¼Œå¯¼è‡´æ•°æ®è¿ç§»å¼€é”€å¤§ã€‚

ä¸€è‡´æ€§å“ˆå¸Œçš„ä¼˜åŠ¿ï¼š
âœ… å‡å°‘æ•°æ®è¿ç§»é‡â€”â€”åªå½±å“ç¯ä¸Šçš„å±€éƒ¨æ•°æ®ï¼Œè€Œéå…¨å±€æ•°æ®ã€‚
âœ… é€‚ç”¨äºåŠ¨æ€æ‰©å±•çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¦‚ç¼“å­˜æœåŠ¡å™¨ã€æ•°æ®åº“åˆ†ç‰‡ç­‰ã€‚

# ğŸ’¡ ä¸€è‡´æ€§å“ˆå¸Œçš„æ”¹è¿›ï¼šè™šæ‹ŸèŠ‚ç‚¹

- é—®é¢˜
  å¦‚æœæœåŠ¡å™¨æ•°é‡è¾ƒå°‘ï¼Œæ•°æ®åˆ†å¸ƒå¯èƒ½ä¸å‡åŒ€ï¼ˆå› ä¸ºæœåŠ¡å™¨å“ˆå¸Œå€¼åˆ†å¸ƒä¸å‡ï¼‰ã€‚
  ä¾‹å¦‚ï¼š 3 å°æœåŠ¡å™¨åˆ†åˆ«æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šçš„ä½ç½®ç›¸å·®è¾ƒè¿œï¼Œå¯¼è‡´æ•°æ®å€¾æ–œï¼ˆæŸäº›æœåŠ¡å™¨å­˜å‚¨çš„æ•°æ®æ¯”å…¶ä»–æœåŠ¡å™¨å¤šï¼‰ã€‚

- -è§£å†³æ–¹æ¡ˆ
  å¼•å…¥â€œè™šæ‹ŸèŠ‚ç‚¹â€ï¼ˆVirtual Nodesï¼‰ï¼š

ä¸ºæ¯å°æœåŠ¡å™¨ç”Ÿæˆå¤šä¸ªå“ˆå¸Œå€¼ï¼Œå‡åŒ€åˆ†å¸ƒåœ¨å“ˆå¸Œç¯ä¸Šã€‚
è¿™æ ·å¯ä»¥è®©æ•°æ®æ›´åŠ å‡åŒ€åœ°åˆ†é…ï¼Œé¿å…è´Ÿè½½ä¸å‡è¡¡çš„é—®é¢˜ã€‚

# Issues with Consistent Hashing

1. Uneven data distribution ("Hotspot")
   "celebrity accounts get more traffic coming in"
   potential sol: same popular movie hashed into multiple values so that get distributed on different servers

known as Hot Partition:

1. use a load balancer, when CPU utilization reaches over 70% create a new instance
2. Virtual Nodes -> generate multiple hash values for a server so that data can be distirbuted more evenly.

3. æ•°æ®åˆ†å¸ƒä¸å‡ï¼ˆçƒ­ç‚¹é—®é¢˜ï¼‰
   å¦‚æœèŠ‚ç‚¹æˆ–è™šæ‹ŸèŠ‚ç‚¹åˆ†å¸ƒä¸å‡è¡¡ï¼ŒæŸäº›èŠ‚ç‚¹å¯èƒ½ä¼šå­˜å‚¨è¿‡å¤šæ•°æ®ï¼Œå¯¼è‡´è´Ÿè½½ä¸å‡ã€‚
   è§£å†³æ–¹æ¡ˆï¼š
   âœ… é‡‡ç”¨ è™šæ‹ŸèŠ‚ç‚¹ï¼ˆvirtual nodesï¼‰ï¼Œè®©æ¯ä¸ªç‰©ç†èŠ‚ç‚¹å¯¹åº”å¤šä¸ªå“ˆå¸Œä½ç½®ï¼Œå‡è¡¡è´Ÿè½½ã€‚
   âœ… é€‰æ‹©æ›´ä¼˜çš„ å“ˆå¸Œå‡½æ•°ï¼ˆå¦‚ MurmurHashã€FNV-1aï¼‰ï¼Œé¿å…æ•°æ®å€¾æ–œã€‚
   âœ… ç»“åˆ è´Ÿè½½æ„ŸçŸ¥è°ƒåº¦ï¼Œæ ¹æ®èŠ‚ç‚¹æ€§èƒ½åˆ†é…æ›´å¤šæˆ–æ›´å°‘çš„è™šæ‹ŸèŠ‚ç‚¹ã€‚

handle weights on the ring itself. or handle weights on the hashing function
